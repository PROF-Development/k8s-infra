apiVersion: apps/v1
kind: Deployment
metadata:
  name: personal-app
spec:
  template:
    metadata:
      annotations:
        vault.hashicorp.com/agent-inject: "true"
        vault.hashicorp.com/role: "personal-app-role"
        vault.hashicorp.com/address: "http://147.45.184.203:8200"
        vault.hashicorp.com/tls-skip-verify: "true"
        vault.hashicorp.com/agent-inject-secret-secrets.env: "secrets/data/test/personal-app"
        vault.hashicorp.com/agent-inject-template-secrets.env: |
          {{- with secret "secrets/data/test/personal-app" -}}
          {{- range $k, $v := .Data.data }}
          export {{ $k }}="{{ $v }}"
          {{- end }}
          {{- end -}}
    spec:
      containers:
        - name: app
          # Пробрасываем секреты в процесс через source
          command: ["/bin/sh", "-c"]
          args: 
            - |
              if [ -f /vault/secrets/secrets.env ]; then
                . /vault/secrets/secrets.env
              fi
              ./app
